
type FightSummary={id:string;week:number;ts:number;a:string;d:string;aStyle?:string;dStyle?:string;winner:"A"|"D"|null;by:"Kill"|"KO"|"Exhaustion"|"Stoppage"|"Draw"|null;minutes:number;tags:string[];tournamentId?:string|null};
type FightCard={summary:FightSummary;transcript:string[]};
type Issue={id:string;week:number;fights:FightCard[];highlights:{fightOfTheWeekId?:string|null;topMovers?:{name:string;fameDelta:number;popDelta:number}[]};styleRollups:Record<string,{w:number;l:number;k:number;pct:number;fights:number}>;createdAt:string};
const Save:any=(globalThis as any).__dmSave, Rollups:any=(globalThis as any).__dmStyleRollups;
function score(f:FightSummary){let s=0; if(f.minutes>=3&&f.minutes<=9)s+=2; if(f.tags?.includes("Comeback"))s+=3; if(f.tags?.includes("Flashy"))s+=2; if(f.tags?.includes("KO"))s+=2; if(f.tags?.includes("Kill"))s+=3; if(f.by==="Draw")s+=1; return s;}
export const NewsletterFeed={_current:[] as FightCard[],appendFightResult(card:FightCard){this._current.push(card); try{Rollups?.addFight?.(card.summary)}catch{} try{Save?.updateNewsletterWorking?.(this._current)}catch{}},closeWeekToIssue():Issue{const week=Save?.getWeek?.()??1, createdAt=new Date().toISOString(), fights=[...this._current], styleRollups=Rollups?.getWeekRollup?.(week)??{}; let bestId:null|string=null, best=-1; for(const c of fights){const sc=score(c.summary); if(sc>best){best=sc; bestId=c.summary.id}} const issue:Issue={id:`issue_${week}`,week,fights,highlights:{fightOfTheWeekId:bestId,topMovers:[]},styleRollups,createdAt}; this._current=[]; try{Save?.pushNewsletterIssue?.(issue)}catch{} return issue;}}; (globalThis as any).__dmNewsletterFeed=NewsletterFeed; export default NewsletterFeed;
